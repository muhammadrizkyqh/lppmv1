name: Deploy to VPS

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate Prisma Client
        run: npx prisma generate
      
      - name: Build Next.js (on GitHub runner)
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: Create deployment package
        run: |
          mkdir -p deploy-package
          
          # Copy standalone build if exists, otherwise copy full .next
          if [ -d ".next/standalone" ]; then
            cp -r .next/standalone deploy-package/.next
            cp -r .next/static deploy-package/.next/static || true
          else
            cp -r .next deploy-package/
          fi
          
          cp -r public deploy-package/
          cp package.json deploy-package/
          cp package-lock.json deploy-package/
          mkdir -p deploy-package/prisma
          cp prisma/schema.prisma deploy-package/prisma/
          cp -r prisma/migrations deploy-package/prisma/ || echo "No migrations to copy"
          
          # Create compressed archive with better compression
          tar -czf deploy.tar.gz --exclude='*.map' --exclude='cache' deploy-package/
          
          # Show package size
          ls -lh deploy.tar.gz
      
      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.VPS_SSH_KEY }}
          known_hosts: 'placeholder'
      
      - name: Add known hosts
        run: ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
      
      - name: Test SSH connection
        run: ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "echo 'SSH connection successful'"
      
      - name: Upload build to VPS
        run: |
          echo "Uploading deployment package..."
          rsync -avz --progress --compress-level=9 -e "ssh -o StrictHostKeyChecking=no" deploy.tar.gz ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/home/deploy/
          echo "Upload complete!"
      
      - name: Deploy and restart on VPS
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          command_timeout: 10m
          script: |
            export PATH=$PATH:/home/deploy/.nvm/versions/node/v24.12.0/bin
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            cd /home/deploy/lppmv1
            
            # Stop application before replacing files
            pm2 stop lppm || echo "App not running"
            
            # Backup current .next
            if [ -d ".next" ]; then
              mv .next .next.backup.$(date +%Y%m%d_%H%M%S)
              ls -t .next.backup.* 2>/dev/null | tail -n +3 | xargs -r rm -rf
            fi
            
            # Extract deployment package
            cd /home/deploy
            tar -xzf deploy.tar.gz
            
            # Verify extraction
            if [ ! -d "deploy-package/.next" ]; then
              echo "ERROR: .next folder not found in deployment package!"
              exit 1
            fi
            
            # Replace build files
            cd /home/deploy/lppmv1
            rm -rf .next public
            cp -r /home/deploy/deploy-package/.next .
            cp -r /home/deploy/deploy-package/public .
            cp /home/deploy/deploy-package/package.json .
            cp /home/deploy/deploy-package/package-lock.json .
            
            # Verify .next exists
            if [ ! -d ".next" ]; then
              echo "ERROR: .next folder copy failed!"
              exit 1
            fi
            
            # Update prisma schema and migrations
            cp /home/deploy/deploy-package/prisma/schema.prisma prisma/
            if [ -d "/home/deploy/deploy-package/prisma/migrations" ]; then
              cp -r /home/deploy/deploy-package/prisma/migrations prisma/
            fi
            
            # Cleanup deploy package
            cd /home/deploy
            rm -rf deploy-package deploy.tar.gz
            
            # Install/update dependencies
            cd /home/deploy/lppmv1
            npm ci --omit=dev || npm install --omit=dev
            
            # Regenerate Prisma Client
            npx prisma generate
            
            # Run migrations
            npx prisma migrate deploy || echo "No migrations to run"
            
            # Verify build exists before restart
            if [ ! -f ".next/BUILD_ID" ]; then
              echo "ERROR: No valid build found!"
              exit 1
            fi
            
            # Restart application
            pm2 restart lppm || pm2 start npm --name lppm -- start
            
            # Save PM2 configuration
            pm2 save
            
            # Check status
            sleep 3
            pm2 status lppm
            pm2 logs lppm --lines 20 --nostream
