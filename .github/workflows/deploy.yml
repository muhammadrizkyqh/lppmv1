name: Deploy to VPS

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate Prisma Client
        run: npx prisma generate
      
      - name: Build Next.js with Standalone (on GitHub runner)
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: Prepare Standalone Deployment Package
        run: |
          # Run deployment preparation script
          npm run deploy:prepare
          
          # Verify standalone folder exists
          if [ ! -d ".next/standalone" ]; then
            echo "ERROR: Standalone folder not created!"
            exit 1
          fi
          
          # Create deployment package from standalone
          mkdir -p deploy-package
          
          # Copy entire standalone folder (contains all needed dependencies)
          cp -r .next/standalone/* deploy-package/
          
          # Copy prisma files for migrations
          mkdir -p deploy-package/prisma
          cp prisma/schema.prisma deploy-package/prisma/
          cp -r prisma/migrations deploy-package/prisma/ || echo "No migrations to copy"
          
          # Copy .env.production if exists
          cp .env.production deploy-package/.env 2>/dev/null || echo "No .env.production found"
          
          # Create compressed archive
          tar -czf deploy.tar.gz deploy-package/
          
          # Show package size comparison
          echo "=========================================="
          echo "üìä Deployment Package Size:"
          ls -lh deploy.tar.gz
          du -sh deploy-package
          echo "=========================================="
          echo "‚úÖ Standalone deployment package ready!"
          echo "This includes all runtime dependencies (no npm install needed on VPS)"
      
      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.VPS_SSH_KEY }}
          known_hosts: 'placeholder'
      
      - name: Add known hosts
        run: ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
      
      - name: Test SSH connection
        run: ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "echo 'SSH connection successful'"
      
      - name: Upload build to VPS
        run: |
          echo "Uploading deployment package..."
          rsync -avz --progress --compress-level=9 -e "ssh -o StrictHostKeyChecking=no" deploy.tar.gz ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/home/deploy/
          echo "Upload complete!"
      
      - name: Deploy Standalone Build and Restart on VPS
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          command_timeout: 10m
          script: |
            export PATH=$PATH:/home/deploy/.nvm/versions/node/v24.12.0/bin
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            echo "üöÄ Starting Standalone Deployment..."
            
            # Stop application before replacing files
            pm2 stop lppm || echo "App not running"
            
            # Backup current deployment (entire folder)
            cd /home/deploy
            if [ -d "lppmv1" ]; then
              echo "üì¶ Creating backup..."
              tar -czf lppmv1-backup-$(date +%Y%m%d_%H%M%S).tar.gz lppmv1
              # Keep only last 3 backups
              ls -t lppmv1-backup-*.tar.gz 2>/dev/null | tail -n +4 | xargs -r rm -f
            fi
            
            # Extract standalone deployment package
            cd /home/deploy
            tar -xzf deploy.tar.gz
            
            # Verify standalone package structure BEFORE moving
            if [ ! -f "deploy-package/server.js" ]; then
              echo "‚ùå ERROR: Standalone server.js not found!"
              echo "Package contents:"
              ls -la deploy-package/
              exit 1
            fi
            
            echo "‚úÖ Standalone package verified"
            echo "üìÇ Package contents:"
            ls -la deploy-package/
            
            # Replace entire application with standalone build
            rm -rf /home/deploy/lppmv1
            mv /home/deploy/deploy-package /home/deploy/lppmv1
            
            cd /home/deploy/lppmv1
            
            # Verify critical files exist AFTER moving
            echo "üìÇ Checking deployed files:"
            ls -la
            
            if [ ! -f "server.js" ]; then
              echo "‚ùå ERROR: server.js missing after deployment!"
              exit 1
            fi
            
            if [ ! -d ".next" ]; then
              echo "‚ùå ERROR: .next folder missing!"
              echo "Current directory contents:"
              ls -la
              exit 1
            fi
            
            echo "‚úÖ File structure verified"
            
            # Copy environment variables (should be on VPS already)
            if [ -f "/home/deploy/.env.production" ]; then
              cp /home/deploy/.env.production .env
              echo "‚úÖ Environment variables copied"
            else
              echo "‚ö†Ô∏è  WARNING: No .env.production found on VPS!"
              echo "Make sure DATABASE_URL and other env vars are set"
            fi
            
            # Run Prisma migrations (Prisma is bundled in standalone)
            if [ -d "prisma" ]; then
              echo "üîß Running Prisma migrations..."
              npx prisma migrate deploy 2>&1 | grep -v "P3005" || echo "Migrations applied or skipped"
            fi
            
            # Cleanup
            cd /home/deploy
            rm -f deploy.tar.gz
            
            echo "=========================================="
            echo "üìä Deployment Size on VPS:"
            du -sh /home/deploy/lppmv1
            echo "=========================================="
            
            # Update PM2 ecosystem to use standalone
            cd /home/deploy/lppmv1
            
            # Create or update PM2 ecosystem file for standalone
            cat > ecosystem.config.js << 'EOF'
            module.exports = {
              apps: [{
                name: 'lppm',
                script: './server.js',
                instances: 1,
                exec_mode: 'cluster',
                env: {
                  NODE_ENV: 'production',
                  PORT: 3000
                },
                error_file: '/home/deploy/.pm2/logs/lppm-error.log',
                out_file: '/home/deploy/.pm2/logs/lppm-out.log',
                log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
                merge_logs: true,
                autorestart: true,
                max_restarts: 10,
                min_uptime: '10s'
              }]
            }
            EOF
            
            # Flush PM2 logs
            pm2 flush lppm || echo "No logs to flush"
            
            # Delete old PM2 process and start with new config
            pm2 delete lppm 2>/dev/null || echo "No existing PM2 process"
            pm2 start ecosystem.config.js
            
            # Save PM2 configuration
            pm2 save
            
            # Ensure PM2 starts on boot
            pm2 startup systemd -u deploy --hp /home/deploy 2>/dev/null || echo "PM2 startup already configured"
            
            echo "‚è≥ Waiting for application to start..."
            sleep 5
            
            # Check status
            pm2 status lppm
            
            echo "=========================================="
            echo "üìã Application Logs (last 30 lines):"
            pm2 logs lppm --lines 30 --nostream
            echo "=========================================="
            
            # Test if app is responding
            if curl -f http://localhost:3000 >/dev/null 2>&1; then
              echo "‚úÖ Application is responding!"
            else
              echo "‚ö†Ô∏è  WARNING: Application might not be responding yet"
              echo "Check logs with: pm2 logs lppm"
            fi
            
            echo "üéâ Standalone deployment complete!"
