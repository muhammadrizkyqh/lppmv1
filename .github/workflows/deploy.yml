name: Deploy to VPS

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate Prisma Client
        run: npx prisma generate
      
      - name: Build Next.js (on GitHub runner)
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: Create deployment package
        run: |
          mkdir -p deploy-package
          cp -r .next deploy-package/
          cp -r public deploy-package/
          mkdir -p deploy-package/node_modules
          cp -r node_modules/.prisma deploy-package/node_modules/
          cp -r node_modules/@prisma deploy-package/node_modules/
          cp package.json deploy-package/
          cp package-lock.json deploy-package/
          cp .env deploy-package/ || echo "No .env file to copy"
          mkdir -p deploy-package/prisma
          cp prisma/schema.prisma deploy-package/prisma/
          cp -r prisma/migrations deploy-package/prisma/ || echo "No migrations to copy"
          tar -czf deploy.tar.gz deploy-package/
      
      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.VPS_SSH_KEY }}
          known_hosts: 'placeholder'
      
      - name: Add known hosts
        run: ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
      
      - name: Test SSH connection
        run: ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "echo 'SSH connection successful'"
      
      - name: Upload build to VPS
        run: rsync -avz -e "ssh -o StrictHostKeyChecking=no" deploy.tar.gz ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/home/deploy/
      
      - name: Deploy and restart on VPS
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          command_timeout: 10m
          script: |
            export PATH=$PATH:/home/deploy/.nvm/versions/node/v24.12.0/bin
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            cd /home/deploy/lppmv1
            
            # Backup current deployment
            if [ -d ".next" ]; then
              mv .next .next.backup.$(date +%Y%m%d_%H%M%S)
              # Keep only last 2 backups
              ls -t .next.backup.* | tail -n +3 | xargs -r rm -rf
            fi
            
            # Extract new build
            cd /home/deploy
            tar -xzf deploy.tar.gz
            
            # Stop application before replacing files
            pm2 stop lppm || echo "App not running"
            
            # Replace files
            cd /home/deploy/lppmv1
            rm -rf .next public
            cp -r /home/deploy/deploy-package/.next .
            cp -r /home/deploy/deploy-package/public .
            mkdir -p node_modules
            cp -r /home/deploy/deploy-package/node_modules/.prisma node_modules/
            cp -r /home/deploy/deploy-package/node_modules/@prisma node_modules/
            
            # Update prisma if needed
            if [ -d "/home/deploy/deploy-package/prisma/migrations" ]; then
              cp -r /home/deploy/deploy-package/prisma/migrations prisma/
            fi
            
            # Cleanup deploy package
            cd /home/deploy
            rm -rf deploy-package deploy.tar.gz
            
            # Back to app directory
            cd /home/deploy/lppmv1
            
            # Regenerate Prisma Client (force fresh)
            rm -rf node_modules/.prisma node_modules/@prisma
            npx prisma generate
            
            # Run migrations safely
            npx prisma migrate deploy || echo "No migrations to run"
            
            # Restart application
            pm2 restart lppm || pm2 start npm --name lppm -- start
            
            # Save PM2 configuration
            pm2 save
            
            # Wait and check status
            sleep 3
            pm2 status lppm
            pm2 logs lppm --lines 20 --nostream
